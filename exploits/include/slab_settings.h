#pragma once
#include <sys/time.h>
#include <sys/resource.h>
#include <errno.h>

/**
 * found best values for large:
 *  $ for i in {1..15}; do echo $i; cat tmp | grep "slab $i " | grep -v not | wc -l; done
 */

// SLAB_SIZE == 4096
#define ALLOCS_4096 512
#define SLAB_PER_CHUNK_4096 15
#define SLAB_RECLAIMED_AS_PAGE_TABLE_4096 9
#define OBJ_PER_SLAB_4096 8
#define YIELD_4096 10000
// SLAB_SIZE == 2048
#define ALLOCS_2048 512
#define SLAB_PER_CHUNK_2048 15
#define SLAB_RECLAIMED_AS_PAGE_TABLE_2048 12
#define OBJ_PER_SLAB_2048 16
#define YIELD_2048 10000
// SLAB_SIZE == 1024
#define ALLOCS_1024 512
#define SLAB_PER_CHUNK_1024 15
#define SLAB_RECLAIMED_AS_PAGE_TABLE_1024 7
#define OBJ_PER_SLAB_1024 16
#define YIELD_1024 10000
// SLAB_SIZE == 512
#define ALLOCS_512 512
#define SLAB_PER_CHUNK_512 15
#define SLAB_RECLAIMED_AS_PAGE_TABLE_512 4
#define OBJ_PER_SLAB_512 16
#define YIELD_512 10000
// SLAB_SIZE == 256
#define ALLOCS_256 512
#define SLAB_PER_CHUNK_256 7
#define OBJ_PER_SLAB_256 16
#define SLAB_RECLAIMED_AS_PAGE_TABLE_256 0
#define YIELD_256 100000
// SLAB_SIZE == 192
#define ALLOCS_192 2048
#define SLAB_PER_CHUNK_192 12
#define OBJ_PER_SLAB_192 21
#define SLAB_RECLAIMED_AS_PAGE_TABLE_192 5
#define YIELD_192 100000
// SLAB_SIZE == 128
#define ALLOCS_128 4096
#define SLAB_PER_CHUNK_128 8
#define OBJ_PER_SLAB_128 32
#define SLAB_RECLAIMED_AS_PAGE_TABLE_128 1
#define YIELD_128 100000
// SLAB_SIZE == 96
#define ALLOCS_96 4096
#define SLAB_PER_CHUNK_96 12
#define OBJ_PER_SLAB_96 42
#define SLAB_RECLAIMED_AS_PAGE_TABLE_96 10
#define YIELD_96 20000
// SLAB_SIZE == 64
#define ALLOCS_64 8192
#define SLAB_PER_CHUNK_64 8
#define OBJ_PER_SLAB_64 64
#define SLAB_RECLAIMED_AS_PAGE_TABLE_64 5
#define YIELD_64 20000
// SLAB_SIZE == 32
#define ALLOCS_32 8192
#define SLAB_PER_CHUNK_32 6
#define OBJ_PER_SLAB_32 128
#define SLAB_RECLAIMED_AS_PAGE_TABLE_32 3
#define YIELD_32 20000
// SLAB_SIZE == 16
#define ALLOCS_16 16384
#define SLAB_PER_CHUNK_16 6
#define OBJ_PER_SLAB_16 256
#define SLAB_RECLAIMED_AS_PAGE_TABLE_16 4
#define YIELD_16 10000
// SLAB_SIZE == 8
#define ALLOCS_8 32768
#define SLAB_PER_CHUNK_8 6
#define OBJ_PER_SLAB_8 512
#define SLAB_RECLAIMED_AS_PAGE_TABLE_8 4
#define YIELD_8 10000

struct slab_info {
    size_t size;
    size_t allocs;
    size_t pre_allocs;
    size_t slab_per_chunk;
    size_t obj_per_slab;
    size_t reclaimed_page_table;
    size_t yield;
};
static struct slab_info slab_infos[] = {
    {
        .size = 4096,
        .allocs = ALLOCS_4096,
        .slab_per_chunk = SLAB_PER_CHUNK_4096,
        .obj_per_slab = OBJ_PER_SLAB_4096,
        .reclaimed_page_table = SLAB_RECLAIMED_AS_PAGE_TABLE_4096,
        .yield = YIELD_4096,
    },
    {
        .size = 2048,
        .allocs = ALLOCS_2048,
        .slab_per_chunk = SLAB_PER_CHUNK_2048,
        .obj_per_slab = OBJ_PER_SLAB_2048,
        .reclaimed_page_table = SLAB_RECLAIMED_AS_PAGE_TABLE_2048,
        .yield = YIELD_2048,
    },
    {
        .size = 1024,
        .allocs = ALLOCS_1024,
        .slab_per_chunk = SLAB_PER_CHUNK_1024,
        .obj_per_slab = OBJ_PER_SLAB_1024,
        .reclaimed_page_table = SLAB_RECLAIMED_AS_PAGE_TABLE_1024,
        .yield = YIELD_1024,
    },
    {
        .size = 512,
        .allocs = ALLOCS_512,
        .slab_per_chunk = SLAB_PER_CHUNK_512,
        .obj_per_slab = OBJ_PER_SLAB_512,
        .reclaimed_page_table = SLAB_RECLAIMED_AS_PAGE_TABLE_512,
        .yield = YIELD_512,
    },
    {
        .size = 256,
        .allocs = ALLOCS_256,
        .slab_per_chunk = SLAB_PER_CHUNK_256,
        .obj_per_slab = OBJ_PER_SLAB_256,
        .reclaimed_page_table = SLAB_RECLAIMED_AS_PAGE_TABLE_256,
        .yield = YIELD_256,
    },
    {
        .size = 192,
        .allocs = ALLOCS_192,
        .slab_per_chunk = SLAB_PER_CHUNK_192,
        .obj_per_slab = OBJ_PER_SLAB_192,
        .reclaimed_page_table = SLAB_RECLAIMED_AS_PAGE_TABLE_192,
        .yield = YIELD_192,
    },
    {
        .size = 128,
        .allocs = ALLOCS_128,
        .slab_per_chunk = SLAB_PER_CHUNK_128,
        .obj_per_slab = OBJ_PER_SLAB_128,
        .reclaimed_page_table = SLAB_RECLAIMED_AS_PAGE_TABLE_128,
        .yield = YIELD_128,
    },
    {
        .size = 96,
        .allocs = ALLOCS_96,
        .slab_per_chunk = SLAB_PER_CHUNK_96,
        .obj_per_slab = OBJ_PER_SLAB_96,
        .reclaimed_page_table = SLAB_RECLAIMED_AS_PAGE_TABLE_96,
        .yield = YIELD_96,
    },
    {
        .size = 64,
        .allocs = ALLOCS_64,
        .slab_per_chunk = SLAB_PER_CHUNK_64,
        .obj_per_slab = OBJ_PER_SLAB_64,
        .reclaimed_page_table = SLAB_RECLAIMED_AS_PAGE_TABLE_64,
        .yield = YIELD_64,
    },
    {
        .size = 32,
        .allocs = ALLOCS_32,
        .slab_per_chunk = SLAB_PER_CHUNK_32,
        .obj_per_slab = OBJ_PER_SLAB_32,
        .reclaimed_page_table = SLAB_RECLAIMED_AS_PAGE_TABLE_32,
        .yield = YIELD_32,
    },
    {
        .size = 16,
        .allocs = ALLOCS_16,
        .slab_per_chunk = SLAB_PER_CHUNK_16,
        .obj_per_slab = OBJ_PER_SLAB_16,
        .reclaimed_page_table = SLAB_RECLAIMED_AS_PAGE_TABLE_16,
        .yield = YIELD_16,
    },
    {
        .size = 8,
        .allocs = ALLOCS_8,
        .slab_per_chunk = SLAB_PER_CHUNK_8,
        .obj_per_slab = OBJ_PER_SLAB_8,
        .reclaimed_page_table = SLAB_RECLAIMED_AS_PAGE_TABLE_8,
        .yield = YIELD_8,
    },
};
struct slab_info *cur = 0;
static inline void set_current_slab_info(size_t size)
{
    int ret;
    struct rlimit l = {
        .rlim_cur = 131072,
        .rlim_max = 131072,
    };
    ret = setrlimit(RLIMIT_NOFILE, &l);
    if (ret < 0)
        pr_perror("setrlimit");
    for (size_t i = 0; i < sizeof(slab_infos)/sizeof(struct slab_info); ++i)
        if (slab_infos[i].size == size)
            cur = &slab_infos[i];
    if (cur == 0)
        pr_error("slab with size %ld not found\n", size);
    pr_debug("slab with size %ld found\n", size);
    pr_debug(" - cur->size           %ld\n", cur->size);
    pr_debug(" - cur->allocs         %ld\n", cur->allocs);
    pr_debug(" - cur->slab_per_chunk %ld\n", cur->slab_per_chunk);
    pr_debug(" - cur->obj_per_slab   %ld\n", cur->obj_per_slab);
    pr_debug(" - cur->reclaimed_page_table     %ld\n", cur->reclaimed_page_table);
    pr_debug(" - cur->yield          %ld\n", cur->yield);
}
