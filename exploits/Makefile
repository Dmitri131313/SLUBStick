obj-m = helper.o
KVERSION = $(shell uname -r)
all: sync build modules remove insert
init: sync build modules insert fuse hugepage
chmod:
	chmod +x userspace/*.elf
remove:
	sudo rmmod helper
insert:
	sudo insmod helper.ko && sudo chmod 666 /dev/helper
modules:
	make -C /lib/modules/$(KVERSION)/build M=$(PWD) modules
clean:
	make -C /lib/modules/$(KVERSION)/build M=$(PWD) clean
	make -C userspace clean
sync: sync-generic sync-userspace
sync-generic:
	wget 10.0.2.2:8000/exploits/helper.c -O helper.c
	wget 10.0.2.2:8000/exploits/eval.py -O eval.py
	wget 10.0.2.2:8000/exploits/keyctl_init.sh -O keyctl_init.sh
	wget 10.0.2.2:8000/exploits/do_eval.sh -O do_eval.sh
	wget 10.0.2.2:8000/exploits/do_eval_pud.sh -O do_eval_pud.sh
	wget 10.0.2.2:8000/exploits/do_eval_pud_no_cpu_pinning.sh -O do_eval_pud_no_cpu_pinning.sh
	wget 10.0.2.2:8000/exploits/do_eval_pud_noise.sh -O do_eval_pud_noise.sh
	wget 10.0.2.2:8000/exploits/do_eval_pmd.sh -O do_eval_pmd.sh
	wget 10.0.2.2:8000/exploits/do_eval_pmd_no_cpu_pinning.sh -O do_eval_pmd_no_cpu_pinning.sh
	wget 10.0.2.2:8000/exploits/do_eval_pmd_noise.sh -O do_eval_pmd_noise.sh
	rm include -rf
	wget 10.0.2.2:8000/exploits/include -r
	mv 10.0.2.2:8000/exploits/include include
	rm 10.0.2.2:8000/ -rf
sync-userspace:
	rm userspace -rf
	wget 10.0.2.2:8000/exploits/userspace -r
	mv 10.0.2.2:8000/exploits/userspace userspace
	rm 10.0.2.2:8000/ -rf
build:
	make -C userspace
fuse:
	mkdir -p dir
	./userspace/fusefs.elf dir
	sudo swapoff -a
hugepage:
	echo 1024 | sudo tee /proc/sys/vm/nr_hugepages